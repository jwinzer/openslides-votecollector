<div class="header">
  <div class="title">
    <div class="submenu">
      <div>
        <a ng-click="openDialog()" os-perms="openslides_votecollector.can_manage_votecollector" class="btn btn-primary btn-sm">
          <i class="fa fa-plus fa-lg"></i>
          <translate>New</translate>
        </a>
        <a ng-click="openRangeDialog()" os-perms="motions.can_manage" class="btn btn-default btn-sm">
          <i class="fa fa-plus fa-lg"></i>
          <translate>New range</translate>
        </a>
        <a ng-click="checkKeypads()" ng-disabled="!vc.canPing()" os-perms="motions.can_manage" class="btn btn-default btn-sm">
          <i class="fa fa-check fa-lg"></i>
          <translate>System test</translate>
        </a>
      </div>
      <div class="spacer">
        <span class="small pull-right">{{ device }}</span>
      </div>
    </div>
    <h1 translate>Keypads</h1>
  </div>
</div>

<div class="details">
  <div class="row">
    <div class="col-sm-6">
      <!-- delete mode -->
      <button os-perms="openslides_votecollector.can_manage_votecollector" class="btn"
          ng-class="$parent.isDeleteMode ? 'btn-primary' : 'btn-default'"
          ng-click="$parent.isDeleteMode = !$parent.isDeleteMode; uncheckAll()">
        <i class="fa fa-check-square-o"></i>
        <translate>Select ...</translate>
      </button>
    </div>
    <!-- search/filter -->
    <div class="col-sm-6">
      <div class="form-inline text-right">
        <div class="form-group">
          <div class="input-group">
            <div class="input-group-addon"><i class="fa fa-search"></i></div>
            <input type="text" ng-model="filter.search" class="form-control"
               placeholder="{{ 'Search' | translate}}">
          </div>
        </div>
        <button class="btn btn-default" ng-click="isFilterOpen = !isFilterOpen"
            ng-class="isFilterOpen ? 'btn-primary' : 'btn-default'">
          <i class="fa fa-filter"></i>
          <translate>Filter ...</translate>
        </button>
      </div>
    </div>
  </div>
  <!-- filter options -->
  <div uib-collapse="!isFilterOpen" class="row spacer">
    <div class="col-sm-6 text-right"></div>
    <div class="col-sm-6 text-right form-inline">
      <!-- user filter -->
      <select ng-model="userFilter" class="form-control" id="userFilter">
        <option value="" translate>--- Select user ---</option>
        <option value="false" translate>Anonymous</option>
        <option value="true" translate>Personalized</option>
      </select>
      <!-- active filter -->
      <select ng-model="activeFilter" class="form-control" id="activeFilter">
        <option value="" translate>--- Select status ---</option>
        <option value="true" translate>Active</option>
        <option value="false" translate>Inactive</option>
      </select>
      <!-- TODO: Add in range and battery filter -->
    </div>
  </div>
  <!-- delete mode options -->
  <div uib-collapse="!isDeleteMode" class="row spacer">
    <div class="col-sm-12 text-left">
      <!-- delete button -->
      <a ng-show="isDeleteMode"
          ng-click="deleteMultiple()"
          class="btn btn-primary">
        <i class="fa fa-trash fa-lg"></i>
        <translate>Delete selected keypads</translate>
      </a>
    </div>
  </div>

  <div class="spacer-top-lg italic">
    {{ keypadsFiltered.length }} /
    {{ keypads.length }} {{ "keypads" | translate }}<span ng-if="(keypads|filter:{selected:true}).length > 0">,
    {{(keypads|filter:{selected:true}).length}} {{ "selected" | translate }}</span>
  </div>

  <table class="table table-striped table-bordered table-hover">
    <thead>
      <tr>
        <!-- delete selection column -->
        <th ng-show="$parent.isDeleteMode" os-perms="openslides_votecollector.can_manage_votecollector" class="minimum deleteColumn">
          <input type="checkbox" ng-model="$parent.selectedAll" ng-change="checkAll()">

        <!-- keypad id column -->
        <th ng-click="toggleSort('keypad_id')" class="sortable">
          <translate>Keypad ID</translate>
          <i class="pull-right fa" ng-show="sortColumn === 'keypad_id' && header.sortable != false"
              ng-class="reverse ? 'fa-sort-desc' : 'fa-sort-asc'">
          </i>

        <!-- user column -->
        <th ng-click="toggleSort('first_name')" class="sortable optional">
          <translate>User</translate>
          <!-- TODO: sort by first OR last name -->
          <i class="pull-right fa" ng-show="sortColumn === 'first_name' && header.sortable != false"
              ng-class="reverse ? 'fa-sort-desc' : 'fa-sort-asc'">
          </i>

        <!-- status column -->
        <th>
          <translate>Status</translate>

        <!-- seat column -->
        <th class="optional">
          <translate>Seat</translate>

        <!-- in_range column -->
        <th class="optional">
          <translate>In range</translate>

        <!-- battery column -->
        <th class="optional">
          <translate>Battery</translate>
    <tbody>
      <tr ng-repeat="keypad in keypadsFiltered = (keypads | osFilter:filter.search:getFilterString |
        filter:{active: activeFilter} | filter:{identified: userFilter} | orderBy:sortColumn:reverse)"
        class="animate-item"
        ng-class="{'selected':keypad.selected}">

        <!-- delete selection -->
        <td ng-show="isDeleteMode" class="deleteColumn">
          <input type="checkbox" ng-model="keypad.selected">

        <!-- keypad id -->
        <td ng-if="!keypad.quickEdit" ng-mouseover="keypad.hover=true" ng-mouseleave="keypad.hover=false">
            <strong>{{ keypad.keypad_id }}</strong>
            <div class="hoverActions" ng-class="{'hiddenDiv': !keypad.hover}">
              <span>
                <a href="" ng-click="openDialog(keypad)" translate>Edit</a>
              </span>
              <span>
                | <a href="" ng-click="keypad.quickEdit=true" translate>QuickEdit</a> |
              </span>
              <span>
                <a href="" class="text-danger"
                  ng-bootbox-confirm="{{ 'Are you sure you want to delete this entry?' | translate }}<br>
                  <b>{{ keypad.getTitle() }}</b>"
                  ng-bootbox-confirm-action="delete(keypad)" translate>Delete</a>
              </span>
            </div>

        <!-- user -->
        <td ng-if="!keypad.quickEdit && keypad.user" class="optional">{{ keypad.user.get_short_name() }}
        <td ng-if="!keypad.quickEdit && !keypad.user" class="optional"><translate>(Anonymous)</translate>

        <!-- state -->
        <td>
          <span ng-if="!keypad.quickEdit && keypad.isActive()" class="label label-success"><translate>active</translate></span>
          <span ng-if="!keypad.quickEdit && !keypad.isActive()" class="label label-warning"><translate>inactive</translate></span>

        <!-- seat -->
        <td ng-if="!keypad.quickEdit && keypad.seat" class="optional">{{ keypad.seat.number }}
        <td ng-if="!keypad.quickEdit && !keypad.seat" class="optional">–

        <!-- in range -->
        <td>
          <span ng-if="!keypad.quickEdit && keypad.in_range" class="label label-success"><translate>yes</translate></span>
          <span ng-if="!keypad.quickEdit && !keypad.in_range" class="label label-danger"><translate>no</translate></span>

        <!-- battery -->
        <td>
          <span ng-if="!keypad.quickEdit" class="optional label label-{{ keypad.powerClass() }}">{{ keypad.power() }}</span>


        <!-- quickEdit columns -->
        <!-- FIXME: quickEdit inserts an empty td, not sure why -->
        <td ng-if="keypad.quickEdit" class="quickmode" colspan="4">
          <h4>{{ keypad.getTitle() }} <span class="text-muted">&ndash; <translate>QuickEdit</translate></span></h4>
            <uib-alert ng-show="alert.show" type="{{ alert.type }}" ng-click="alert={}" close="alert={}">
              {{ alert.msg }}
            </uib-alert>
            <div class="row">
              <div class="col-xs-4">
                <label for="inputKeypad" translate>Keypad ID</label>
                <input type="number" ng-model="keypad.keypad_id" class="form-control input-sm"
                    id="inputKeypad">
              </div>
              <div class="col-xs-4">
                <label for="selectUser" translate>Participant</label>
                <select chosen
                    ng-model="keypad.user_id"
                    ng-options="user.id as user.full_name for user in users"
                    search-contains="true"
                    id="selectUser"
                    class="form-control">
                  <option value="" translate>(Anonymous)</option>
                </select>
              </div>
              <div class="col-xs-4">
                <label for="selectSeat" translate>Seat</label>
                <select chosen
                    ng-model="keypad.seat_id"
                    ng-options="seat.id as seat.number for seat in seats"
                    search-contains="true"
                    id="selectSeat"
                    class="form-control">
                  <option value="">–</option>
                </select>
              </div>
            </div>
            <div class="spacer">
              <button ng-click="cancelQuickEdit(keypad)" class="btn btn-default pull-left" translate>
                Cancel
              </button> &nbsp;
              <button ng-click="save(keypad)" class="btn btn-primary" translate>
                Update
              </button>
              <!-- <a href="" ng-click="openDialog(keypad)"
                  class="pull-right" translate>Edit keypad ...</a> -->
            </div>
  </table>

</div>